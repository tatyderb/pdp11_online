# Список команд PDP-11

lesson = 514365


## Константы в языке Си

| Константа | Равно десятичному числу |
|----|-----|
| `12` | 12 |
| `012` | 10 |
| `0x12` | 18 |

## И без конца до конца

Если вы нашли, что слово - это команда `add`, то вы прекращаете искать или упорно проверяете, уж не `mov` или `halt` она?

`break` наше все. Или `return`, если у вас отдельная функция поиска команды.

## Segmentation Fault

После стольких задач на динамическую память вы удивляетесь, как вы смогли ошибиться в таком простом коде?

1. Делаем небольшие изменения кода. Что вы изменили в последний раз? Вот эти 100 строк кода? Давайте это будет последнее ваше крупное изменение без промежуточных тестов. Не надо так.

2. Запускаем `valgrind` и смотрим, где произошла ошибка. В `for` поиска команды? Давайте проверим, не выходите ли вы где за границы массива `commands` или у вас по `halt` программа не останавливается.

### Как хорошо написать цикл по массиву commands?

Вариант 1. Очень плохой. Считать количество команд в массиве на пальцах и хардкодить эту константу.

```cpp
for (i = 0; i < 3; i++)
```
В коде не должно быть "магических чисел", например, числа 3. Можно использовать 0 или 1. Остальные числа нужно записывать в именованные константы или вычислять.

Нам придется добавлять новые команды или закомментировать поиск по уже сделанным. Рано или поздно число в `for` разойдется с реальным размером массива. Это любовно разложенные грабли в коде.

Вариант 2. Вычисляем размер массива.

```cpp
for (i = 0; i < sizeof(commands)/sizeof(commands[0]); i++)
```
Работает великолепно, пока у нас `commands` массив, а не указатель на него. Если массив передали в функцию, то все, sizeof вернет размер указателя, а не всех данных в этом массиве.

Вариант 3. Команда-"ловушка" в конце массива `commands`.

Напишите **последней** в массиве несуществующую команду с такими маской и опкодом, чтобы она всегда ловилась. Дайте ей имя `unknown`.

Не забудьте рядом с ней написать комментарий "Эта команда должна быть всегда последней в массиве!". Иначе рано или поздно кто-то захочет отсортировать массив по названию команды, опкоду еще какому-то критерию и "ловушка" окажется не в конце массива. Цикл тогда пишем с пустым условием продолжения цикла (продолжаем всегда, выходить будем только когда найдем команду).

```cpp
for(i = 0; ; i++)
```