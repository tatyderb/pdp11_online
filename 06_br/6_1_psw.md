# PSW: флаги N, Z, V, C

lesson = 320176

## SKIP VIDEO Все видео

https://youtu.be/Yne6NBcLyAg

## SKIP VIDEO Видео этого урока

https://youtu.be/S2H03g372OY

## Задача модуля

Вы уже добились работы теста, в котом суммируется массив чисел из N чисел. Использовали команду `SOB` и суммировали как массив слов, так и массив байт.

Сегодня мы научимся суммировать массив чисел неизвестной длины, последний элемент массива 0. Тесты

* [03_arr0](https://github.com/tatyderb/pdp11_tests/tree/master/03_arr0)
* [03_arr0_byte](https://github.com/tatyderb/pdp11_tests/tree/master/03_arr0_byte)

Для этого реализуем флаги состояния процессора N, Z, V (не обязательно), C. И напишем вместе с юнит тестами команды ветвления: `BR` и только те команды, которые будут в интеграционных тестов. *Оставим побольше простых команд на зачет*.

## PSW - process state word, слово состояния процессора

Зачем нам эти флаги? Во-первых, раньше мы игнорировали проблемы, которые возникают при программировании на ассемблере.

При сложении может возникнуть переполнение и/или знаковое переполнение. Мы никак не пытались отследить эту ситуацию. У нас не было для этого инструментов.

Хочется иметь не только команду `ADD`, но и написать обработку ошибок.

Во-вторых, условные операторы и циклы с условием. Для их реализации нужны команды.

В обычной программе до 30% машинных команд приходится на *if условие then переход по адресу*, даже без конструкции *else*. Значит, чтобы программа была короче, набор команд ветвления должен быть достаточно мощным, а сами команды - компактными. 

Чаще всего выполняются проверки:

* `if (x == 0)`
* `if (x != 0)`
* `if (x < 0)`, `> 0`,  `<= 0`, `>= 0`

Конструкции вида `x < y` сводятся к сравнению с нулем `x - y < 0`.

Проверки нужно делать быстро, то есть перевести на уровень простых электросхем.

Для каждой типичной проверки создадим ячейку в 1 бит, в которой будем писать результат этой проверки для последней выполненной команды. Критериев проверки несколько, значит нужно несколько бит. Эти биты объединяются в **слово состояния процессора**, **Process State Word, PSW**. В нем много флагов. Подробно разберем только 4 флага N, Z, V, C. Реализуем только 3 флага, NZC, без флага V.

PSW - это отдельная ячейка, не память RAM и не регистры. Состоит из флагов, флаг - это 1 бит, в нем может быть 1 (флаг выставлен/поднят) или 0 (флаг не выставлен).

Команды могут изменять эти флаги или опрашивать их состояние и совершать действия. Разберем это на примерах.

## NZVC

* **Z** (**z**ero) - флаг выставлен в 1, если **результат команды 0**; иначе значение флага 0.
* **N** (**n**egative) - флаг выставлен в 1, если **результат команды** `< 0`; иначе значение флага 0.
* **C** (**c**arry, дополнительный бит, считайте, что сложение проходит в 17 битах, а не в 16. И флаг С - это тот самый старший, дополнительный бит).
* **V** (o**V**erflow) - знаковое переполнение, когда результат операции имеет неверный знак).

Напомним, чем отличается переполнение от знакового переполнения.

### Сложим числа `-1 + 1`

```
C|15            8|7             0| - номера бит и флаг С
 |0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|1| - 1
 |1|1|1|1|1|1|1|1|1|1|1|1|1|1|1|1| - -1
----------------------------------
1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0| - 1+(-1) = 0 в слове и С=1
```
* `C=1`, возникло переполнение,
* `V=0`, никаких неожиданностей в знаке результата нет,
* `N=0`, знаковый бит результата 0.
* `Z=1`, результат 0.

### Сложим два очень больших положительных числа так, чтобы получилось отрицательное число

```
C|15            8|7             0| - номера бит и флаг С
 |0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0| - большое положительное число
 |0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0| - большое положительное число
----------------------------------
0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0| - отрицательное число
```
* `C=0`, переполнения нет. 
* Но есть **знаковое переполнение**, результат операции удивляет математиков, флаг `V=1`.
* Флаг `N=1`, так как результат отрицательный.
* Флаг `Z=0`, так как результат не равен 0.

### -1 + -1

```
C|15            8|7             0| - номера бит и флаг С
 |1|1|1|1|1|1|1|1|1|1|1|1|1|1|1|1| - -1
 |1|1|1|1|1|1|1|1|1|1|1|1|1|1|1|1| - -1
----------------------------------
1|1|1|1|1|1|1|1|1|1|1|1|1|1|1|1|0| - -2
```
* `C=1`, возникло переполнение,
* `V=0`, никаких неожиданностей в знаке результата нет,
* `N=1`, знаковый бит результата 0.
* `Z=0`, результат 0.

### Реализация флагов NZVC

На ваше усмотрение. Хотите объявите 4 разных глобальных переменных, хотите одну глобальную переменную PSW и в ней выставляйте флаги (можно в отдельных битах, можно объявить структуру с битовыми полями, как вам будет удобнее).

Стоит реализовать функции `set_NZ` и `set_C`. Или придумать другие функции для работы с флагами.

## SKIP 6+(-3)

В какие значения выставляются флаги NZVC в результате сложения чисел 6 и -3 ?


