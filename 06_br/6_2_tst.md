# Выставление флагов командами

lesson = 320177

## SKIP VIDEO Все видео

https://youtu.be/JIKZ7CO_x3o

## Описание выставления флагов командами

В таблице команд ассемблера есть столбец NZVC. В нем описано, как изменяются флаги по результату работы команды.

| Обозначение | Означает |
|----|----|
| `0` | Флаг выставляется в 0 |
| `1` | Флаг выставляется в 1 |
| `*` | Флаг выставляется по результату операции |
| `-` | Флаг не изменяется |

Пример описания команд:

| Мнемоника | Opcode | NZVC | Описание | Комментарии |
|-----|----|----|----|----|
| ADD s, d | 06SSDD | `****` | Add | d = s + d |
| BR   a      | 0004XX   | `----`   | Branch  | PC=PC+2*XX   | 
| MOVb s,d    | B1SSDD   | `**0-`   | Move                         | d=s          | 
| TSTb d      | B057DD   | `**00`   | Test  | d            | 
| CMPb s,d    | B2SSDD   | `****`| Compare                      | s-d          | 

* `MOV` и `MOVB` - выставляют только флаги N и Z, флаг С не трогают, V=0.
* `BR` - не изменяет флаги.
* `TST` и `TSTB` - выставляет флаги N и Z, обнуляя V и С.

Команда **TST** (от слова test, проверить) используется для выставления по аргументу *d* флагов.

Аналогично, команда **CMP** (от слова compare, сравнить), вычисляет разность аргументов *s-d* и по этой разности выставляет все флаги.

Заметим, что байтовые версии команд **TSTB** и **CMPB** флаг `N` выставляют по знаковому биту одного байта, то есть биту с номером 7.

Эти команды нужно будет реализовать в эмуляторе. О команде `BR` мы расскажем подробнее позже.

## Кодирование команд set/clear флагов (condition code operations) 

* **CLx** - очистить (clear) флаг x; команды `CLN`, `CLZ`, `CLV`,`CLC` - флаг = 0.
* **SEx** - установить (set) флаг x; команды `SEN`, `SEZ`, `SEV`,`SEC` - флаг = 1.
* **CCC** - снять все флаги (clear all condition codes).
* **SCC** - установить все флаги (set all condition codes).
* **NOP** - холостой такт процессора (no operation), нужен, чтобы процессор, например, дождался чтения данных.

| Мнемоника | Opcode | NZVC | Описание | Комментарии |
|-----|----|----|----|----|
| CCC         | 000257   | `0000`   | Clear all Condition Codes    | {C,N,V,Z}=0  | 
| CLC         | 000241   | `---0`   | Clear Carry                  | C=0          | 
| CLN         | 000250   | `0---`   | Clear Negative               | N=0          | 
| CLV         | 000242   | `--0-`   | Clear Overflow               | V=0          | 
| CLZ         | 000244   | `-0--`   | Clear Zero                   | Z=0          | 
| NOP         | 000240   | `----`   | No Operation                 |              | 
| SCC         | 000277   | `1111`   | Set all Condition Codes      | {C,N,V,Z}=1  | 
| SEC         | 000261   | `---1`   | Set Carry                    | C=1          | 
| SEN         | 000270   | `1---`   | Set Negative                 | N=1          | 
| SEV         | 000262   | `--1-`   | Set Overflow                 | V=1          | 
| SEZ         | 000264   | `-1--`   | Set Zero                     | Z=1          | 

Коды всех этих операций сделаны по следующему формату:

```
|15            8|7             0| - номера бит
|0|0|0|0|0|0|0|0|1|0|1|s|N|Z|V|C| - содержимое бит, бинарные числа
|0|  0  |  0  |  2  |  4+ |     | - содержимое бит, восьмеричные числа
```
* последние 4 бита соответствуют флагам NZVC, 1 - операция влияет на флаг, 0 - операция не влияет на флаг.
* s = 1, если флаг устанавливают, 0, если флаг обнуляют.

То есть команда `SEZ`, устанавливающая флаг Z:
```
|15            8|7             0| - номера бит
|0|0|0|0|0|0|0|0|1|0|1|s|N|Z|V|C| - формат кодирования команд
|0|0|0|0|0|0|0|0|1|0|1|1|0|1|0|0| - SEZ
|0|  0  |  0  |  2  |  6  |  4  | - восьмеричный код команды.
```
Команда `ССС` - обнуление всех флагов:
```
|15            8|7             0| - номера бит
|0|0|0|0|0|0|0|0|1|0|1|s|N|Z|V|C| - формат кодирования команд
|0|0|0|0|0|0|0|0|1|0|1|0|1|1|1|1| - CCC
|0|  0  |  0  |  2  |  5  |  7  | - восьмеричный код команды.
```
